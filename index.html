<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>BLOCK GAMES</title>

<style>
body{margin:0;background:#0b1a33;color:#fff;font-family:system-ui;overflow:hidden}
header{
  height:64px;background:#09162c;
  display:grid;grid-template-columns:1fr auto 1fr;
  align-items:center;padding:0 10px
}
#left,#center,#right{display:flex;flex-direction:column;gap:4px}
#center{align-items:center}
#right{align-items:flex-end}
#logo{font-size:20px;font-weight:bold}
#settingsBtn{background:none;border:none;color:#fff;font-size:18px}
canvas{display:block}

.overlay{
  position:fixed;inset:0;background:#000c;
  display:none;z-index:10;
  align-items:center;justify-content:center;
}
.panel{
  background:#112;padding:20px;border-radius:12px;
  min-width:260px;
}
#errorText{
  font-size:22px;
  animation:blink 0.8s infinite;
}
@keyframes blink{50%{opacity:.3}}
</style>
</head>

<body>

<header>
  <div id="left">
    <div id="hiscore">HI: 0</div>
    <div id="stageLabel">STAGE 1</div>
  </div>
  <div id="center">
    <div id="logo">BLOCK GAMES</div>
  </div>
  <div id="right">
    <button id="settingsBtn">‚öôÔ∏è</button>
    <div id="life">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    <div id="score">SCORE 0</div>
  </div>
</header>

<canvas id="game"></canvas>

<!-- üîç Ê§úÁ¥¢ -->
<div id="search" class="overlay">
  <div class="panel">
    <button onclick="closeSearch()">‚Üê Êàª„Çã</button>
    <h3>Ê§úÁ¥¢ÔºàDuckDuckGoÔºâ</h3>
    <input id="q" placeholder="Ê§úÁ¥¢„ÉØ„Éº„Éâ"
      style="width:100%;padding:10px">
    <button onclick="searchDDG()"
      style="width:100%;margin-top:10px">Ê§úÁ¥¢</button>
  </div>
</div>

<!-- ‚öôÔ∏è Ë®≠ÂÆö -->
<div id="settings" class="overlay">
  <div class="panel">
    <h3>Ë®≠ÂÆö</h3>
    „Çπ„ÉÜ„Éº„Ç∏ÈÅ∏Êäû
    <select id="stageSelect"></select><br><br>
    BGM <input type="range" id="bgmVol" min="0" max="1" step="0.01"><br>
    SE <input type="range" id="seVol" min="0" max="1" step="0.01"><br><br>
    <button onclick="closeSettings()">Èñâ„Åò„Çã</button>
  </div>
</div>

<!-- ‚ùå ÂÅΩ„Éê„Ç∞ÁîªÈù¢ -->
<div id="fakeError" class="overlay">
  <div id="errorText">Error...<br>Rebooting...</div>
</div>

<script>
/* ===== Âü∫Êú¨ ===== */
const canvas=game,ctx=canvas.getContext("2d"),H=64;
function resize(){canvas.width=innerWidth;canvas.height=innerHeight-H}
resize();addEventListener("resize",resize);

/* ===== Áä∂ÊÖã ===== */
let stage=1,score=0,life=5;
let hi=+localStorage.hi||0;
hiscore.textContent="HI: "+hi;

/* ===== „É≠„Ç¥5„Çø„ÉÉ„Éó ===== */
let tap=0;
logo.onclick=()=>{ if(++tap>=5){openSearch();tap=0;} };

/* ===== Ê§úÁ¥¢ ===== */
function searchDDG(){
  const q=document.getElementById("q").value.trim();
  if(q) window.open("https://duckduckgo.com/?q="+encodeURIComponent(q),"_blank");
}
function openSearch(){search.style.display="flex";}
function closeSearch(){search.style.display="none";}

/* ===== „Çµ„Ç¶„É≥„Éâ ===== */
const bgm=new Audio("https://cdn.pixabay.com/audio/2022/03/15/audio_8bdf5f3f9c.mp3");
bgm.loop=true;bgm.volume=0.3;bgm.play();
const se=new Audio("https://cdn.pixabay.com/audio/2022/03/15/audio_64c97b8c0b.mp3");
bgmVol.oninput=e=>bgm.volume=e.target.value;
seVol.oninput=e=>se.volume=e.target.value;

/* ===== „Ç≤„Éº„É† ===== */
let paddle={x:200,w:100};
let balls=[],blocks=[];
let secret=false;

function setBalls(){
  balls=[{x:canvas.width/2,y:300,vx:secret?10:6,vy:-6}];
}
function makeBlocks(){
  blocks=[];
  for(let i=0;i<20;i++)
    blocks.push({
      x:Math.random()*(canvas.width-60),
      y:Math.random()*200+40,
      w:60,h:20,
      c:secret?"#000":`hsl(${Math.random()*360},100%,60%)`
    });
}

function resetGame(){
  setBalls();makeBlocks();
}

resetGame();

/* ===== „É°„Ç§„É≥ ===== */

let miss = false; // ‚ô°„Åå‰∏ÄÊ∞ó„Å´Ê∏õ„Çã„ÅÆ„ÇíÈò≤„Åê„Éï„É©„Ç∞

function resetGame(){
  setBalls();
  makeBlocks();
}

resetGame();

function loop(){
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  /* „Éë„Éâ„É´ÊèèÁîª */
  ctx.fillStyle = "#fff";
  ctx.fillRect(paddle.x, canvas.height - 20, paddle.w, 10);

  /* „Éú„Éº„É´Âá¶ÁêÜ */
  balls.forEach(b => {
    b.x += b.vx;
    b.y += b.vy;

    if (b.x < 0 || b.x > canvas.width) b.vx *= -1;
    if (b.y < 0) b.vy *= -1;

    // „Éë„Éâ„É´ÂèçÂ∞Ñ
    if (
      b.y + 6 > canvas.height - 20 &&
      b.x > paddle.x &&
      b.x < paddle.x + paddle.w
    ) {
      b.vy = -Math.abs(b.vy);
    }

    // ‚¨á‚¨á‚¨á ‚ô°„ÅåÊ∏õ„ÇãÊú¨‰ΩìÔºà„Åì„Åì„ÅåÈáçË¶ÅÔºâ
    if (b.y > canvas.height && !miss) {
      miss = true;
      life--;

      if (life <= 0) {
        stage = 1;
        score = 0;
        life = 5;
      }

      resetGame();
    }

    ctx.beginPath();
    ctx.arc(b.x, b.y, 6, 0, Math.PI * 2);
    ctx.fill();
  });

  /* „Éñ„É≠„ÉÉ„ÇØÂá¶ÁêÜ */
  blocks.forEach((bl, i) => {
    ctx.fillStyle = bl.c;
    ctx.fillRect(bl.x, bl.y, bl.w, bl.h);

    balls.forEach(b => {
      if (
        b.x > bl.x &&
        b.x < bl.x + bl.w &&
        b.y > bl.y &&
        b.y < bl.y + bl.h
      ) {
        blocks.splice(i, 1);
        b.vy *= -1;
        score += secret ? 200 : 100;
        se.currentTime = 0;
        se.play();
      }
    });
  });

  /* „Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ */
  if (blocks.length === 0) {
    stage++;
    secret = false;
    resetGame();
  }

  /* UIÊõ¥Êñ∞ */
  scoreEl.textContent = "SCORE " + score;
  stageLabel.textContent = "STAGE " + stage;
  lifeEl.textContent = "‚ù§Ô∏è".repeat(life);
  hi = Math.max(hi, score);
  localStorage.hi = hi;
  hiscore.textContent = "HI: " + hi;

  miss = false; // „Éï„É¨„Éº„É†ÁµÇ‰∫ÜÊôÇ„Å´Ëß£Èô§
  requestAnimationFrame(loop);
}

loop();
/* ===== Êìç‰Ωú ===== */
addEventListener("mousemove",e=>paddle.x=e.clientX-paddle.w/2);
addEventListener("touchmove",e=>paddle.x=e.touches[0].clientX-paddle.w/2);

/* ===== Ë®≠ÂÆö & ÂÅΩ„Éê„Ç∞ ===== */
let selectCount=0;
settingsBtn.onclick=()=>{
  stageSelect.innerHTML="";
  for(let i=1;i<=Math.max(stage,20);i++){
    let o=document.createElement("option");
    o.value=i;o.textContent="STAGE "+i;
    stageSelect.appendChild(o);
  }
  settings.style.display="flex";
};

stageSelect.onchange=e=>{
  if(+e.target.value===13){
    selectCount++;
    if(selectCount>=3){
      settings.style.display="none";
      fakeError.style.display="flex";
      setTimeout(()=>{
        fakeError.style.display="none";
        secret=true;
        stage=999;
        resetGame();
      },1500);
      selectCount=0;
      return;
    }
  } else selectCount=0;

  stage=+e.target.value;
  resetGame();
};

function closeSettings(){settings.style.display="none";}
</script>

</body>
</html>
